# Casos de Uso - Autenticación

## Índice

| Código | Nombre |
|--------|--------|
| UC-AUTH-01 | Registro de usuario |
| UC-AUTH-02 | Inicio de sesión |
| UC-AUTH-03 | Cierre de sesión |
| UC-AUTH-04 | Renovación de token |
| UC-AUTH-05 | Solicitud de restablecimiento de contraseña |
| UC-AUTH-06 | Restablecimiento de contraseña |
| UC-AUTH-07 | Consulta de perfil de usuario |

---

## UC-AUTH-01: Registro de usuario

**Actores:** Usuario no autenticado

**Descripción:** Un visitante crea una nueva cuenta proporcionando sus datos personales y credenciales, obteniendo acceso inmediato al sistema.

### Precondiciones
- El usuario no tiene una sesión activa.
- El usuario se encuentra en la página de registro (`/[locale]/register`).

### Postcondiciones
- Se crea una cuenta con el rol "Customer".
- Se genera un token JWT y un refresh token.
- El usuario es redirigido a la página principal con sesión iniciada.

### Flujo principal
1. El sistema muestra el formulario de registro con los campos: nombre, apellido, email, contraseña, confirmar contraseña y aceptación de términos.
2. El usuario completa todos los campos obligatorios.
3. El sistema valida en el cliente:
   - Email con formato válido.
   - Contraseña con mínimo 8 caracteres, al menos una mayúscula, una minúscula y un dígito.
   - Contraseña y confirmación coinciden.
   - Términos aceptados.
4. El sistema envía la petición `POST /api/auth/register`.
5. El backend crea el usuario, le asigna el rol "Customer" y genera los tokens.
6. El sistema almacena los tokens y datos del usuario en el store local.
7. El sistema redirige al usuario a la página principal, mostrando el mensaje de bienvenida.

### Flujos alternativos

**FA-01: Email ya registrado**
- En el paso 5, si el email ya existe, el backend responde con `400 Bad Request`.
- El sistema muestra el mensaje "This email is already registered".
- El usuario puede corregir el email y reintentar.

**FA-02: Contraseña no cumple la política**
- En el paso 5, si la contraseña no cumple los requisitos del servidor, el backend responde con `400 Bad Request`.
- El sistema muestra el error devuelto por el servidor.

**FA-03: Validación del cliente falla**
- En el paso 3, si algún campo no es válido, el sistema muestra los errores inline junto a cada campo.
- No se realiza la petición al servidor.

**FA-04: Error de red**
- En el paso 4, si la petición falla por problemas de conexión, el sistema muestra un mensaje genérico de error.

---

## UC-AUTH-02: Inicio de sesión

**Actores:** Usuario no autenticado (registrado previamente)

**Descripción:** Un usuario existente accede al sistema proporcionando sus credenciales, obteniendo un token de acceso y un refresh token.

### Precondiciones
- El usuario tiene una cuenta registrada.
- El usuario no tiene una sesión activa.
- El usuario se encuentra en la página de login (`/[locale]/login`).

### Postcondiciones
- Se genera un token JWT (60 min) y un refresh token (7 días).
- El usuario es redirigido a la página principal con sesión iniciada.

### Flujo principal
1. El sistema muestra el formulario de login con los campos: email, contraseña, y la opción "Recordarme".
2. El usuario introduce su email y contraseña.
3. El sistema valida que el email tenga formato válido y la contraseña no esté vacía.
4. El sistema envía la petición `POST /api/auth/login`.
5. El backend verifica las credenciales y genera los tokens.
6. El sistema almacena los tokens y datos del usuario en el store local.
7. El sistema redirige al usuario a la página principal.

### Flujos alternativos

**FA-01: Credenciales inválidas**
- En el paso 5, si el email no existe o la contraseña es incorrecta, el backend responde con `401 Unauthorized`.
- El sistema muestra "Invalid email or password. Please try again."
- El contador de intentos fallidos se incrementa en 1.

**FA-02: Cuenta bloqueada**
- En el paso 5, si el usuario ha alcanzado 5 intentos fallidos consecutivos, el backend responde con `401 Unauthorized` indicando bloqueo temporal.
- El sistema muestra "Account temporarily locked. Please try again later."
- La cuenta se desbloquea automáticamente tras 15 minutos.

**FA-03: Email no verificado**
- En el paso 5, si la verificación de email está habilitada y el email no ha sido verificado, el backend responde con `403 Forbidden`.
- El sistema muestra "Please verify your email before signing in."

**FA-04: Usuario autenticado accede al login**
- En la precondición, si el usuario ya tiene sesión activa, el `AuthRedirectGuard` lo redirige automáticamente a la página principal.
- No se muestra el formulario de login.

---

## UC-AUTH-03: Cierre de sesión

**Actores:** Usuario autenticado

**Descripción:** Un usuario con sesión activa cierra su sesión, revocando todos sus tokens e invalidando el acceso.

### Precondiciones
- El usuario tiene una sesión activa con tokens válidos.

### Postcondiciones
- Todos los refresh tokens del usuario son revocados.
- El security stamp se actualiza, invalidando todos los JWT existentes.
- El estado local de autenticación se limpia.
- El usuario ve la interfaz de visitante (botones "Sign In" y "Create Account").

### Flujo principal
1. El usuario hace clic en el botón "Log Out" visible en la página principal.
2. El sistema envía la petición `POST /api/auth/logout` con el token JWT.
3. El backend revoca todos los refresh tokens activos del usuario.
4. El backend actualiza el security stamp del usuario.
5. El sistema limpia el store local (token, usuario, estado de autenticación).
6. La interfaz se actualiza mostrando los enlaces de "Sign In" y "Create Account".

### Flujos alternativos

**FA-01: Error en la petición de logout**
- En el paso 2, si la petición falla (error de red, token expirado), el sistema limpia igualmente el estado local.
- El usuario queda desconectado en el frontend independientemente de la respuesta del servidor.

---

## UC-AUTH-04: Renovación de token

**Actores:** Sistema (automático)

**Descripción:** El sistema renueva automáticamente el token JWT cuando una petición recibe un error 401, utilizando el refresh token para obtener nuevos credenciales sin intervención del usuario.

### Precondiciones
- El usuario tiene una sesión activa.
- Existe un refresh token válido (no expirado, no revocado) en el store local.

### Postcondiciones
- Se genera un nuevo token JWT y un nuevo refresh token.
- El refresh token anterior es revocado y reemplazado (rotación de tokens).
- La petición original que falló se reintenta con el nuevo token.

### Flujo principal
1. El cliente HTTP intercepta una respuesta `401 Unauthorized` en cualquier petición autenticada.
2. El interceptor envía la petición `POST /api/auth/refresh-token` con el refresh token actual.
3. El backend valida el refresh token, lo revoca y genera un par de tokens nuevos.
4. El sistema actualiza el store local con los nuevos tokens.
5. El interceptor reenvía la petición original con el nuevo token JWT.
6. El usuario continúa su actividad sin interrupciones.

### Flujos alternativos

**FA-01: Refresh token expirado o revocado**
- En el paso 3, si el refresh token no es válido, el backend responde con `401 Unauthorized`.
- El sistema limpia el estado de autenticación.
- El usuario es redirigido al login.

**FA-02: Múltiples peticiones concurrentes fallan**
- En el paso 1, si varias peticiones reciben 401 simultáneamente, el interceptor encola las peticiones pendientes.
- Solo se realiza una petición de refresh.
- Una vez completada la renovación, todas las peticiones encoladas se reintentan con el nuevo token.

---

## UC-AUTH-05: Solicitud de restablecimiento de contraseña

**Actores:** Usuario no autenticado

**Descripción:** Un usuario que ha olvidado su contraseña solicita un enlace de restablecimiento por email. El sistema responde siempre con éxito por seguridad, independientemente de si el email existe.

### Precondiciones
- El usuario se encuentra en la página de "Forgot Password" (`/[locale]/forgot-password`).

### Postcondiciones
- Si el email existe, se envía un correo con un enlace de restablecimiento (token válido por 24 horas).
- El sistema muestra la pantalla de confirmación con la dirección de email indicada.

### Flujo principal
1. El sistema muestra el formulario con un campo de email.
2. El usuario introduce su dirección de email.
3. El sistema valida que el formato del email sea correcto.
4. El sistema envía la petición `POST /api/auth/forgot-password`.
5. El backend genera un token de restablecimiento y envía el email (si la cuenta existe).
6. El backend responde siempre con `200 OK` (prevención de enumeración de emails).
7. El sistema muestra la pantalla de confirmación "Check Your Email" con la dirección proporcionada.
8. Se inicia un temporizador de 60 segundos para permitir reenvío.

### Flujos alternativos

**FA-01: Email no registrado**
- En el paso 5, si el email no existe, el backend no envía correo pero responde igualmente con `200 OK`.
- El usuario ve la misma pantalla de confirmación (no se revela si el email existe).

**FA-02: Reenvío de email**
- Tras el paso 8, una vez transcurridos los 60 segundos, el botón "Resend Email" se habilita.
- El usuario puede hacer clic para reenviar la solicitud.
- Se reinicia el temporizador de 60 segundos.

**FA-03: Cambiar email**
- Desde la pantalla de confirmación, el usuario hace clic en "Try a different email".
- El sistema vuelve a mostrar el formulario con el campo de email vacío.

**FA-04: Error de red**
- En el paso 4, si la petición falla, el sistema muestra "Could not send email. Please try again."

---

## UC-AUTH-06: Restablecimiento de contraseña

**Actores:** Usuario no autenticado

**Descripción:** Un usuario establece una nueva contraseña utilizando el enlace de restablecimiento recibido por email, que contiene un token de un solo uso.

### Precondiciones
- El usuario ha recibido un email con el enlace de restablecimiento.
- El token no ha expirado (24 horas desde su generación) y no ha sido utilizado.
- El usuario accede a `/[locale]/reset-password?token={token}&email={email}`.

### Postcondiciones
- La contraseña del usuario se actualiza.
- El security stamp se actualiza, invalidando todos los tokens JWT y refresh tokens existentes.
- El usuario debe iniciar sesión nuevamente con la nueva contraseña.

### Flujo principal
1. El sistema muestra el formulario con los campos: nueva contraseña y confirmar contraseña, junto con los indicadores de requisitos de contraseña.
2. El usuario introduce la nueva contraseña cumpliendo los requisitos:
   - Mínimo 8 caracteres.
   - Al menos una letra mayúscula.
   - Al menos una letra minúscula.
   - Al menos un dígito.
3. El usuario confirma la contraseña.
4. El sistema valida que ambas contraseñas coincidan y cumplan los requisitos.
5. El sistema envía la petición `POST /api/auth/reset-password` con el email, token y nueva contraseña.
6. El backend verifica el token, actualiza la contraseña, revoca todos los tokens activos y actualiza el security stamp.
7. El sistema muestra la pantalla de éxito con un enlace para iniciar sesión.

### Flujos alternativos

**FA-01: Token inválido o expirado**
- En el paso 6, si el token no es válido o ha expirado, el backend responde con `400 Bad Request`.
- El sistema muestra la pantalla de "token inválido" con un enlace a "Forgot Password" para solicitar uno nuevo.

**FA-02: Contraseña no cumple requisitos**
- En el paso 4, si la contraseña no cumple los requisitos, el sistema muestra los indicadores de requisitos no cumplidos.
- No se realiza la petición al servidor.

**FA-03: Contraseñas no coinciden**
- En el paso 4, si las contraseñas no coinciden, el sistema muestra el error "Passwords do not match".

---

## UC-AUTH-07: Consulta de perfil de usuario

**Actores:** Usuario autenticado

**Descripción:** El sistema obtiene los datos del perfil del usuario autenticado para mostrar información personalizada en la interfaz.

### Precondiciones
- El usuario tiene una sesión activa con un token JWT válido.

### Postcondiciones
- Se obtienen los datos actualizados del usuario (id, email, nombre, apellido, idioma, estado de verificación, roles).

### Flujo principal
1. El sistema envía la petición `GET /api/auth/me` con el token JWT en la cabecera de autorización.
2. El backend valida el token JWT y el security stamp.
3. El backend busca al usuario por ID y obtiene sus roles.
4. El backend responde con los datos del usuario (`UserDto`).
5. El sistema actualiza el store local con la información recibida.

### Flujos alternativos

**FA-01: Token expirado**
- En el paso 2, si el token JWT ha expirado, el backend responde con `401 Unauthorized`.
- Se activa el flujo de renovación de token (UC-AUTH-04).
- Tras la renovación, se reintenta la petición.

**FA-02: Usuario no encontrado**
- En el paso 3, si el usuario ya no existe en el sistema, el backend responde con `404 Not Found`.
- El sistema limpia el estado de autenticación y redirige al login.

**FA-03: Security stamp inválido**
- En el paso 2, si el security stamp del token no coincide con el actual (por cambio de contraseña o logout en otro dispositivo), el backend rechaza el token.
- Se limpia el estado de autenticación y se redirige al login.
